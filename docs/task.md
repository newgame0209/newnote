## しゃべるノートの新規タスク

優先順位は実装のしやすさと影響の少なさなどを考慮して実装していってください。

## 完全なる新機能
1. 新規登録ページの作成と現状のデータベースへの反映とテーブル、RLSポリシーの作成
現状の仕様だと、新規登録・認証・ログイン・ログアウト・ユーザーごとの操作と反映機能を入れていません。
つまり、誰でもノートが閲覧・書き込み・削除できる状態です。

これを新規登録できるようにし、ユーザーごとにノート作成・編集・削除・保存・閲覧ができるようにします。

現状は、DBはSQ Liteで作成しており、バックエンドサーバーはrenderを使用しています。
必要情報があれば確認してください。

## ノート一覧の未実装
1. ノート一覧に実装されているAIの音声設定の機能に喋るスピードの調整欄も追加します。
早い・ノーマル・ゆっくりの3つを追加し、ノートとメモの編集ページで音声変換した際に、
選択したスピードでAI音声が喋るように反映させます。

現状はgoogleのOCR APIでで文字を読み取り、googleのTTSのAPIを使って音声変換しています。

## キャンバス機能の未実装
1. ノートにしおり機能を追加します。
ユーザーがノートの好きなページにしおりを入れることができます。現状だと10Pが最大なので、10個しおりを挟むことができます。
しおりを入れることで、ノートを閉じて再度開く前にどのページで開けるかが選択できます。しおりを入れているページは一覧で表示され
好きなページを選択すると、そのページでノートが開きます。

2. 一個前に戻すボタン
一つ前の作業に戻すことができます。

3. ipadでの描画時にapple pencilのみ反応するようにする
現状だと、指にも反応しているため、ipadはapple pencilのみに反応するようにします。

## メモ機能の未実装
1. メモ内に入力したテキストの中で音声変換したい箇所のみを選択して
音声変換ができるようにする。

現状だと、入力したテキストすべてを変換していますが、これをユーザーが選択したテキスト
のみを変換できるようにします。

2. メモのページ追加。
現状だと、ノートとは違い、メモの場合、新規ページの追加ができないので
毎回、新しいメモを作成しなければいけません。一つの新規メモ内にノートと同様で
ページを追加できるようにします。ノートと同様で最大10Pで問題ないです。

# 「しゃべるノート」Ver2 実装計画

## タスク分析

### 目的
「しゃべるノート」アプリケーションにver2として新機能を実装し、ユーザーエクスペリエンスを向上させる。

### 技術要件
- フロントエンド: React + TypeScript + Vite + Tailwind CSS
- バックエンド: Flask + Python + SQLite
- 主要ライブラリ:
  - フロントエンド: fabric.js（キャンバス描画）、axios（API通信）、@radix-ui/react-*（UIコンポーネント）
  - バックエンド: google-cloud-texttospeech、SQLAlchemy、flask-cors、flask-limiter

### 実装手順
1. 新規登録・認証機能の追加
2. 音声設定機能の拡張（スピード調整）
3. ノートのしおり機能追加
4. 操作取り消し機能の追加
5. iPad対応（Apple Pencilのみ反応）
6. メモテキスト選択時の音声変換機能
7. メモページの追加機能

### リスク
- 既存機能への影響
- データベーススキーマの変更による互換性問題
- 認証機能実装によるセキュリティリスク
- デバイス固有機能（Apple Pencil）の実装の複雑さ

### 品質基準
- TypeScriptの型安全性確保
- レスポンシブデザインの維持
- エラーハンドリングの徹底
- パフォーマンスの最適化

## 実装計画

### 1. 新規登録・認証機能の追加

#### 詳細な実装内容
1. **データベーススキーマの拡張**
   - ユーザーテーブルの作成（id, username, email, password_hash, created_at）
   - ノートとメモテーブルにuser_idカラムを追加してリレーション設定
   - Row Level Security (RLS)ポリシーの設定

2. **バックエンド実装**
   - 認証エンドポイントの追加（登録、ログイン、ログアウト）
   - JWTによる認証の実装
   - ユーザー関連APIの実装（プロフィール取得・更新）
   - 既存APIの修正（ユーザーごとのデータフィルタリング）

3. **フロントエンド実装**
   - 新規登録ページの作成
   - ログインページの作成
   - 認証状態管理のためのコンテキスト作成
   - 保護されたルートの実装
   - 既存ページのユーザー固有データ表示への対応

#### 予想される課題と対策
- **既存データの移行**: 既存のデータをユーザーアカウントに関連付ける方法
  - 対策: 初回ログイン時に既存データを自動的に関連付けるマイグレーションスクリプト作成
- **セキュリティ**: パスワードハッシュ化やトークン管理
  - 対策: bcryptによるパスワードハッシュ化、JWTの安全な管理

### 2. 音声設定機能の拡張（スピード調整）

#### 詳細な実装内容
1. **SettingsContextの拡張**
   - `speakingRate`状態の追加（値: 0.75, 1.0, 1.5など）
   - 設定保存機能の追加

2. **SettingsDialogの更新**
   - スピード選択UIの追加（早い・ノーマル・ゆっくり）

3. **API通信の拡張**
   - `synthesizeSpeech`関数に`speakingRate`パラメータを追加
   - バックエンドTTSエンドポイント更新

#### 予想される課題と対策
- **既存コードとの互換性**: 設定の保存・読み込みロジックの変更
  - 対策: デフォルト値を設定し、段階的に移行

### 3. ノートのしおり機能追加

#### 詳細な実装内容
1. **データモデルの拡張**
   - Bookmarkテーブルの作成またはNoteに`bookmarks`フィールド追加

2. **バックエンドAPI**
   - しおり追加/削除/取得のエンドポイント追加

3. **フロントエンド実装**
   - NoteEditorにしおりUIの追加
   - しおり一覧表示と選択機能
   - しおりによるページジャンプ機能

#### 予想される課題と対策
- **UIの複雑化**: しおり機能追加によるUIの複雑化
  - 対策: シンプルなUIデザインの採用、必要時のみ表示

### 4. 操作取り消し機能の追加

#### 詳細な実装内容
1. **Fabric.jsの機能拡張**
   - キャンバス履歴管理の実装
   - `undo`メソッドの実装

2. **UIの追加**
   - 取り消しボタンの追加
   - キーボードショートカット（Ctrl+Z）

#### 予想される課題と対策
- **メモリ使用量**: 履歴データの増加によるメモリ使用量の増加
  - 対策: 履歴の最大数制限、必要に応じて古い履歴を破棄

### 5. iPad対応（Apple Pencil対応）

#### 詳細な実装内容
1. **タッチイベント処理の修正**
   - Apple Pencil検出ロジックの追加
   - 指によるタッチのフィルタリング

2. **デバイス検出**
   - iPadデバイス検出の実装

#### 予想される課題と対策
- **デバイス依存コード**: 端末固有の機能実装の複雑さ
  - 対策: Webブラウザの標準APIの使用、フォールバックメカニズムの実装

### 6. メモテキスト選択時の音声変換機能

#### 詳細な実装内容
1. **テキスト選択の実装**
   - 選択テキスト取得機能の追加

2. **音声変換API呼び出し**
   - 選択テキストのみを変換するロジック追加

3. **UI更新**
   - 選択テキスト変換のUIボタン追加

#### 予想される課題と対策
- **選択状態の管理**: 複数プラットフォームでの選択テキスト取得の一貫性
  - 対策: クロスブラウザ対応のselection APIの使用

### 7. メモページの追加機能

#### 詳細な実装内容
1. **データモデルの拡張**
   - メモに`pages`フィールドを追加

2. **バックエンドAPI**
   - ページ管理エンドポイントの追加

3. **フロントエンド実装**
   - ページナビゲーションUIの追加
   - ページ切り替え機能

#### 予想される課題と対策
- **データ構造の変更**: 単一ページから複数ページへの移行
  - 対策: 既存データの保持とマイグレーション戦略の慎重な設計

## 優先順位とスケジュール

以下の優先順位で実装を進めます：

1. **音声設定機能の拡張（スピード調整）**
   - 実装の複雑さ: 低
   - 影響範囲: 小
   - 事前準備要件: なし

2. **メモテキスト選択時の音声変換機能**
   - 実装の複雑さ: 中
   - 影響範囲: 中
   - 事前準備要件: なし

3. **操作取り消し機能の追加**
   - 実装の複雑さ: 中
   - 影響範囲: 中
   - 事前準備要件: なし

4. **ノートのしおり機能追加**
   - 実装の複雑さ: 中
   - 影響範囲: 中
   - 事前準備要件: なし

5. **メモページの追加機能**
   - 実装の複雑さ: 高
   - 影響範囲: 中
   - 事前準備要件: なし

6. **iPad対応（Apple Pencil対応）**
   - 実装の複雑さ: 高
   - 影響範囲: 小
   - 事前準備要件: なし

7. **新規登録・認証機能の追加**
   - 実装の複雑さ: 高
   - 影響範囲: 大
   - 事前準備要件: データベーススキーマの変更

## テスト戦略

各機能実装後には以下のテストを行います：

1. **単体テスト**
   - コンポーネント単位のテスト
   - API個別エンドポイントのテスト

2. **統合テスト**
   - 機能間の連携テスト
   - フロントエンドとバックエンドの接続テスト

3. **ユーザーシナリオテスト**
   - 実際のユースケースに基づいたテスト
   - エラー処理の検証

4. **クロスブラウザテスト**
   - 主要ブラウザでの動作確認
   - モバイルデバイスでの表示テスト
